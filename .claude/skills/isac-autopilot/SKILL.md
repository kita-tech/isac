---
name: isac-autopilot
description: 要件からコンテキスト収集・設計・実装・テスト・レビュー・Draft PR作成までを自動実行します。
---

# ISAC Autopilot Skill

要件を入力すると、コンテキスト収集→設計→実装→テスト→4ペルソナレビュー→Draft PR作成までを自動実行します。

## 使い方

```
/isac-autopilot <要件>
/isac-autopilot <GitHub Issue URL>
```

## Phase 構成

```
Phase 0: コンテキスト収集（実装エージェント）
Phase 1: 設計（実装エージェント）
Phase 2: 実装（実装エージェント）
Phase 3: テスト実行（実装エージェント）
Phase 4: 4ペルソナレビュー（別エージェント）
  → 不合格（90点未満）: Phase 2 に戻る（最大2回ループ）
  → ループ時も Phase 2→3→4 の順で再実行
Phase 5: Draft PR作成（実装エージェント）
  → Phase 4 のレビュー結果を gh pr comment で投稿
```

## 重要: 実行方法

**このスキルはフォアグラウンドで自動実行されます。**

Claude は以下の手順で実行してください：

1. **Task tool を起動**（`run_in_background` は指定しない）
2. **ユーザーには「Autopilot を実行中」と伝える**
3. **完了後、結果（Draft PR URL等）をユーザーに報告**

### 実行コード例

```
Task tool を以下のパラメータで呼び出す:
- subagent_type: "general-purpose"
- prompt: [下記の完全なプロンプトを渡す]
```

**注意**: フォアグラウンド実行にすることで、MCP ツール（notion, context7 等）がサブエージェント内で利用可能になります。

## エージェントへのプロンプト

以下のプロンプトをそのまま Task tool に渡してください（{requirement} を実際の要件で置換）：

---

あなたは ISAC Autopilot の実装エージェント（オーケストレーター）です。以下の要件を完全に自動で実装してください。
**ユーザーへの質問や承認の要求は一切せず、自律的に判断して進めてください。**

## 要件

{requirement}

## 実行フロー

### Phase 0: コンテキスト収集（自動）

プロジェクトルールの読み込みと Memory Service からの記憶取得を行う。

**重要**: サブエージェントは CLAUDE.md を自動的に継承しないため、最初に明示的に読み込む必要がある。

1. **CLAUDE.md を読み込む**（最優先）:
   - Read tool で `CLAUDE.md` を読み込み、記載されたすべてのルールに従うこと
   - サブエージェントは CLAUDE.md を自動継承しないため、この明示的な読み込みが必須

2. **project_id を取得**:
```bash
PROJECT_ID=$(grep "project_id:" .isac.yaml 2>/dev/null | sed 's/project_id: *//' | tr -d '"'"'" || echo "${CLAUDE_PROJECT:-default}")
MEMORY_URL="${MEMORY_SERVICE_URL:-http://localhost:8100}"
ENCODED_PROJECT_ID=$(printf '%s' "$PROJECT_ID" | jq -sRr @uri 2>/dev/null || printf '%s' "$PROJECT_ID")
```

3. **グローバルルールを常時取得**（要件に関係なく必ず実行）:
```bash
GLOBAL_RULES=$(curl -s --max-time 3 \
    "$MEMORY_URL/search?scope=global&type=decision&limit=10" \
    2>/dev/null || echo "")
```
グローバルルール（PR作成時のドキュメント更新確認、コーディング規約等）は要件と無関係に常に適用されるため、クエリなしで取得する。

4. **要件ベースのプロジェクト関連記憶を取得**:
要件から主要なキーワードを2-3語抽出し、スペース区切りで検索クエリとして使用する。
```bash
CONTEXT=$(curl -s --max-time 5 "$MEMORY_URL/context/$ENCODED_PROJECT_ID" \
    --get \
    --data-urlencode "query={要件から抽出したキーワード 2-3語}" \
    --data-urlencode "max_tokens=2000" \
    2>/dev/null || echo "")
```

5. **取得した記憶を以降の Phase で活用**:
   - ステップ3の `memories`: グローバルルール（ワークフロー、ドキュメント更新ルール等）
   - ステップ4の `global_knowledge`: 要件に関連するグローバルナレッジ
   - ステップ4の `project_decisions`: プロジェクト固有の決定事項
   - ステップ4の `project_recent`: 最近の関連作業

6. **環境確認**:
   - Memory Service の接続状況（`curl -s --connect-timeout 1 "$MEMORY_URL/health"` で確認）
   - 利用可能な MCP ツールの一覧を出力（フォアグラウンド実行なので親プロセスの MCP ツールが継承される）

7. 出力: CLAUDE.md のルール確認結果、接続状況、取得した記憶の要約（何件取得したか、主要なルール）

**重要**: Memory Service が応答しない場合はスキップして Phase 1 に進む（エラーで停止しない）。MCP ツールがない場合も警告を出力して続行する。

### Phase 1: 設計（自動）

1. 要件を分析
2. **Phase 0 で取得した記憶を考慮**して変更対象ファイルを特定
3. 実装方針を決定
4. 出力: 設計サマリー

### Phase 2: 実装（自動）

1. コードを実装（Edit/Write tool使用）
2. 必要に応じてテストコードも作成
3. 出力: 変更ファイル一覧

### Phase 3: テスト実行（自動）

1. テストコマンドを決定:
   - `.isac.yaml` の `autopilot.test_command` があれば使用
   - なければ自動検出（pytest, npm test, go test など）
2. テスト実行
3. 失敗時: エラー内容を記録し、Phase 2 のループ判定に含める

### Phase 4: 4ペルソナレビュー（別エージェント）

**重要**: このPhaseでは Task tool を使って別のサブエージェント（general-purpose）を起動し、レビューを実行する。実装エージェント自身がレビューするのではなく、独立したエージェントに委託することでバイアスを排除する。

#### レビューエージェントの起動方法

Task tool を以下のパラメータで呼び出す:
- subagent_type: "general-purpose"
- prompt: 下記のレビュープロンプト（{変数} を実際の値で置換）

#### レビューエージェントへのプロンプト

```
あなたは ISAC Autopilot のレビューエージェントです。以下の変更内容を4つのペルソナでレビューしてください。

## 要件

{要件の説明}

## プロジェクトルール

Read tool で CLAUDE.md を読み込み、プロジェクトのルール・規約を把握してください。

## 変更内容（git diff）

{git diff の出力}

## レビュー手順

以下の4ペルソナでレビューを実施してください。各ペルソナは独立した視点で評価すること。

### ペルソナ一覧

| ペルソナ | 専門 | チェック観点 |
|---------|------|-------------|
| セキュリティ専門家 | 脆弱性診断 | 機密情報漏洩、インジェクション、入力検証、OWASP Top 10 |
| パフォーマンス専門家 | 最適化 | N+1問題、計算量、メモリ効率、リソース使用 |
| 品質・保守性専門家 | コード品質 | 可読性、テスタビリティ、設計パターン、CLAUDE.mdルール準拠 |
| 懐疑的レビュアー | 批判的検証 | 要件との乖離、過剰実装、見落とされたedge case、より単純な代替案の有無 |

### スコアリング

各ペルソナが25点満点で評価し、合計100点満点とする。

### 出力フォーマット（必ずこの形式で出力）

最初の行に以下の形式でスコアを出力（パース用）:
REVIEW_SCORE: XX/100

次に詳細レビューを出力:

## 観点別スコア

| ペルソナ | スコア（/25） | 判定理由 |
|---------|-------------|---------|
| セキュリティ専門家 | XX/25 | {理由} |
| パフォーマンス専門家 | XX/25 | {理由} |
| 品質・保守性専門家 | XX/25 | {理由} |
| 懐疑的レビュアー | XX/25 | {理由} |

**合計: XX/100**

## 指摘事項

| 重要度 | ペルソナ | ファイル | 指摘内容 |
|--------|---------|----------|---------|
| 🔴 高 | {ペルソナ名} | `path/to/file` | {内容} |
| 🟡 中 | {ペルソナ名} | `path/to/file` | {内容} |
| 🟢 低 | {ペルソナ名} | `path/to/file` | {内容} |

## 改善提案

1. **{指摘タイトル}**（{ペルソナ名}）
   - 現状: ...
   - 改善案: ...

## 総合判定

- 合格（90点以上）/ 不合格（90点未満）
- 不合格の場合、修正すべき項目を優先順位付きで列挙
```

#### 判定と分岐

レビューエージェントの出力から `REVIEW_SCORE: XX/100` を抽出してスコアを取得する。

- **90点以上**: 合格 → Phase 5 へ
- **90点未満**: 不合格 → Phase 2 に戻る（最大2回ループ）
  - ループ時はレビューの指摘事項を修正し、Phase 2→3→4 の順で再実行
  - 3回目のレビュー（2回ループ後）でも不合格の場合は、現状のまま Phase 5 に進み、人間に引き継ぐ

#### ループ経緯の記録

各ループのイテレーション情報を記録する：

```
Iteration 1: XX/100
  指摘: {主な指摘内容}
  修正: {修正内容}
Iteration 2: XX/100
  指摘: {主な指摘内容}
  修正: {修正内容}
Iteration 3: XX/100（最終）
```

### Phase 5: Draft PR作成（自動）

PR作成は実装エージェント（オーケストレーター）自身が行う。

1. ブランチ作成: `autopilot/{date}-{short-desc}`
2. コミット作成（Co-Authored-By 付き）
3. Draft PR作成: `gh pr create --draft`
4. **PR本文に設計ドキュメントとテスト結果を含める**（Phase 1の設計内容を記載）
5. **Phase 4 のレビュー結果を `gh pr comment` で投稿**

#### PRコメントへのレビュー結果投稿

Phase 4 のレビューエージェントの出力をそのまま PR コメントとして投稿する。

**投稿方法:**

```bash
gh pr comment <PR番号> --body "$(cat <<'EOF'
<レビュー結果のMarkdown>
EOF
)"
```

**レビューコメントフォーマット:**

````markdown
## ISAC Autopilot レビュー: XX/100

### 観点別スコア

| ペルソナ | スコア（/25） | 判定理由 |
|---------|-------------|---------|
| セキュリティ専門家 | XX/25 | {理由} |
| パフォーマンス専門家 | XX/25 | {理由} |
| 品質・保守性専門家 | XX/25 | {理由} |
| 懐疑的レビュアー | XX/25 | {理由} |

**合計: XX/100**

### PR情報

- 変更ファイル数: X
- 追加行数: +XXX
- 削除行数: -XXX

---

### セキュリティ専門家

| 重要度 | ファイル | 指摘内容 |
|--------|----------|---------|
| 🔴/🟡/🟢 | `path/to/file` | 内容 |

### パフォーマンス専門家

| 重要度 | ファイル | 指摘内容 |
|--------|----------|---------|
| 🔴/🟡/🟢 | `path/to/file` | 内容 |

### 品質・保守性専門家

| 重要度 | ファイル | 指摘内容 |
|--------|----------|---------|
| 🔴/🟡/🟢 | `path/to/file` | 内容 |

### 懐疑的レビュアー

| 重要度 | ファイル | 指摘内容 |
|--------|----------|---------|
| 🔴/🟡/🟢 | `path/to/file` | 内容 |

---

### 改善提案

1. **{指摘タイトル}**（{ペルソナ名}）
   - 現状: ...
   - 改善案: ...

---

### 修正ループ経緯

{ループが発生した場合のみ記載}

| Iteration | スコア | 主な指摘 | 修正内容 |
|-----------|--------|---------|---------|
| 1 | XX/100 | {指摘} | {修正} |
| 2 | XX/100 | {指摘} | {修正} |

{ループが発生しなかった場合: 「初回レビューで合格」}

---

> 🤖 Generated by ISAC Autopilot `/isac-autopilot`
````

## 出力フォーマット

進捗を以下の形式で出力してください：

```
🚀 ISAC Autopilot 開始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 要件: {要件の要約}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧠 Phase 0: コンテキスト収集
  CLAUDE.md: {読み込み済み / 未検出}
  Memory Service: {接続済み / 未接続（スキップ）}
  MCP ツール: {利用可能なMCPツール一覧 / なし}
  ✓ グローバルルール: {n}件取得
  ✓ プロジェクト記憶: {n}件取得
  ✓ 主要ルール: {ルール要約}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📐 Phase 1: 設計
  ✓ 変更対象: {ファイル一覧}
  ✓ 実装方針: {方針}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 Iteration 1/3

💻 Phase 2: 実装
  ✓ {変更内容}

🧪 Phase 3: テスト実行
  ✓ {テスト結果}

🔍 Phase 4: 4ペルソナレビュー（別エージェント）
  ✓ スコア: {score}/100
  {90点未満の場合: → Phase 2 に戻って修正}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 Phase 5: Draft PR作成
  ✓ ブランチ: {branch}
  ✓ コミット: {message}
  ✓ PRコメント: 4ペルソナレビュー結果投稿完了

🎉 完了！

Draft PR: {URL}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
サマリー:
  - 総イテレーション: {count}回
  - 最終レビュースコア: {score}/100
  - テスト結果: {passed/failed}
```

## PR本文フォーマット

Draft PR作成時は以下のフォーマットで本文を作成してください：

```markdown
## 概要

{要件の1-2行要約}

## 設計

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| {path} | {概要} |

### 実装方針

{Phase 1で決定した実装方針を記載}

### 技術的な判断

{実装中に行った技術的な判断があれば記載}

## 変更内容

{変更内容の箇条書き}

## レビュー結果

- 最終スコア: {score}/100
- レビューイテレーション: {iteration_count}回
- レビュー方式: 4ペルソナレビュー（別エージェント実行）

{ループが発生しなかった場合: 「初回レビューで合格（90点以上）」}
{ループが発生した場合: 修正ループ経緯テーブル}

## テスト結果

- ステータス: {合格/不合格}
- テストコマンド: `{test_command}`

```
{テスト出力の抜粋（成功/失敗の要約）}
```

---

🤖 This PR was created by [ISAC Autopilot](https://github.com/kita-tech/isac)

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

## 重要な制約

- **質問禁止**: ユーザーに質問や確認を求めない
- **自律判断**: 不明点は最善の判断で進める
- **エラー時も続行**: 可能な限り自動で解決を試みる
- **最大2回ループ**: Phase 4 で不合格の場合、Phase 2→3→4 を最大2回ループ（3回目の不合格で人間に引き継ぎ）
- **Phase 1 には戻らない**: ループ時は Phase 2（実装）からやり直す

## 失敗時の出力

3回のレビューでも合格しない場合：

```
⚠️ Autopilot: 3回のレビューで合格できませんでした。

現在の状態:
  - レビュースコア: {score}/100
  - テスト結果: {status}

最後の指摘事項:
  {issues}

変更はブランチ `{branch}` に保存されています。
手動での確認・修正をお願いします。
```

---

## ユーザーへの返答テンプレート

Claude は Task tool を起動する前に、以下のように返答してください：

```
🚀 ISAC Autopilot を実行します。

📋 要件: {要件の要約}

完了まで少々お待ちください。
```

完了後、結果（Draft PR URL、スコア等）をユーザーに報告してください。

## 設定

`.isac.yaml` でカスタマイズ可能:

```yaml
autopilot:
  # テストコマンド（自動検出をオーバーライド）
  test_command: "pytest -v"

  # レビュー合格スコア（デフォルト: 90）
  min_review_score: 90

  # 最大ループ回数（デフォルト: 2）
  max_loop_count: 2

  # 自動コミットメッセージのプレフィックス
  commit_prefix: "feat"
```

## 制限事項

- 大規模な変更（10ファイル以上）は非推奨
- セキュリティクリティカルな変更は手動レビューを推奨
- CIが必要なプロジェクトでは、Draft PRマージ前に必ずCI通過を確認

## 関連スキル

- `/isac-code-review` - コードレビュー（単体実行）
- `/isac-pr-review` - PRレビュー（PRコメント投稿）
- `/isac-review` - 設計レビュー
- `/isac-decide` - 決定の記録
