# テスト設計ガイドライン

ISACプロジェクトにおけるテスト設計の標準ガイドライン。

## 概要

10人のペルソナによるレビューで決定されたテスト設計のベストプラクティス。
AIがテストを生成する際、およびレビュー時に参照する。

## 必須テストカテゴリ

全ての機能に対して以下のテストを必須とする。

### 1. 正常系テスト

期待通りの入力で期待通りの結果を得られることを確認。

```
例: Todo追加
- 有効なタスク内容で追加できる
- 追加後にリストに表示される
```

### 2. 境界値テスト

入力パラメータの境界条件を網羅的にテスト。

| パラメータ種別 | テストすべき値 |
|---------------|---------------|
| 数値 | 最小値、最小値-1、最小値+1、最大値、最大値-1、最大値+1、0 |
| 文字列長 | 0文字、1文字、上限文字数、上限+1文字 |
| 配列 | 空配列、1件、上限件数、上限+1件 |
| 日付 | 過去、現在、未来、境界日 |

```
例: タスク内容
- 空文字（0文字）
- 1文字
- 60文字（表示上限）
- 300文字（長い入力）
```

### 3. 異常系テスト

不正な入力やエラー条件での動作を確認。正常系と同数以上のケースを作成。

| カテゴリ | テスト内容 |
|----------|-----------|
| 不正な型 | 数値に文字列、文字列にnull等 |
| 不正な値 | 存在しないID、無効なステータス |
| 権限エラー | 他ユーザーのリソースアクセス |
| リソースエラー | 存在しないリソース |

```
例: Todo完了
- 存在しないIDで完了操作 → 404エラー
- 他ユーザーのTodoを完了 → 権限エラー
- 既に完了済みのTodoを再完了 → 適切なハンドリング
```

### 4. 特殊文字テスト

文字列を扱う全ての処理で必須（グローバル決定）。

#### 必須テストケース

| 文字種 | 例 | 確認観点 |
|--------|-----|---------|
| 改行 | `\n` | 複数行の保存・表示 |
| ダブルクォート | `"` | JSONエスケープ |
| シングルクォート | `'` | SQLエスケープ |
| バックスラッシュ | `\\` | エスケープシーケンス |
| バッククォート | `` ` `` | シェルコマンド |
| ドル記号 | `$` | 変数展開 |
| タブ | `\t` | 空白文字 |
| 山括弧 | `<>` | HTML/XMLエスケープ |
| アンパサンド | `&` | URLエンコード |
| 日本語 | `日本語` | マルチバイト |
| 絵文字 | `😀` | サロゲートペア |

#### テスト観点（3段階）

1. **保存**: 特殊文字が正しく保存されるか
2. **取得**: 特殊文字が正しく取得されるか
3. **表示**: 特殊文字が正しく表示されるか

```bash
# テスト例（Bash）
declare -a SPECIAL_CHARS=(
    'タスク with "double quotes"'
    "タスク with 'single quotes'"
    'タスク with <brackets> & ampersand'
    'タスク with backslash \\ here'
    'タスク with backtick ` here'
    'タスク with dollar $VAR sign'
    $'タスク with tab\there'
)
```

## 条件付き必須カテゴリ

機能の特性に応じて追加するテスト。

### 状態遷移テスト

**対象**: 状態を持つ機能（Todo、ワークフロー等）

| テスト種別 | 内容 |
|-----------|------|
| 正常遷移 | pending → done |
| 不正遷移の拒否 | done → pending（許可しない場合） |
| 遷移条件 | 特定条件でのみ遷移可能 |

```
例: Todoステータス
- pending → done: OK
- done → pending: 仕様による（許可/拒否）
- deleted状態からの復元: 不可
```

### セキュリティテスト

**対象**: 外部入力を扱うAPI、認証が必要な機能

| テスト種別 | 内容 |
|-----------|------|
| SQLインジェクション | `'; DROP TABLE --` |
| XSS | `<script>alert(1)</script>` |
| パストラバーサル | `../../etc/passwd` |
| 認証バイパス | トークンなし、無効トークン |
| 認可バイパス | 他ユーザーのリソースアクセス |

### 並行処理テスト

**対象**: 複数ユーザー/プロセスが同時にアクセスする機能

| テスト種別 | 内容 |
|-----------|------|
| 同時書き込み | 2つのプロセスが同時に更新 |
| 競合検出 | 楽観的ロックの動作確認 |
| デッドロック | 複数リソースの同時ロック |

### 国際化テスト

**対象**: 文字列表示、多言語対応機能

| テスト種別 | 内容 |
|-----------|------|
| 多言語 | 日本語、中国語、アラビア語（RTL） |
| 長い文字 | ドイツ語の長い複合語 |
| Unicode正規化 | NFC/NFD の違い |

## テスト設計チェックリスト

テストケース作成時に確認すること。

### 入力パラメータごとに確認

- [ ] 正常値（代表値）
- [ ] 境界値（最小、最大、境界±1）
- [ ] 異常値（null、空、不正形式）
- [ ] 特殊文字（改行、クォート、制御文字）

### 機能全体で確認

- [ ] 正常系フロー（ハッピーパス）
- [ ] エラーハンドリング（エラーメッセージ、ステータスコード）
- [ ] 状態遷移（該当する場合）
- [ ] 権限チェック（該当する場合）

### 非機能要件

- [ ] パフォーマンス（大量データでの動作）
- [ ] セキュリティ（入力検証、認証・認可）
- [ ] 可用性（エラー時のリカバリ）

## テストレビュー

### 重要機能のテストレビュー

重要な機能のテストは10人レビュー（`/isac-review --team`）を実施。

```
/isac-review テストケースの網羅性 --team
```

### レビュー観点

1. **網羅性**: 上記チェックリストが満たされているか
2. **再現性**: テストが独立して実行可能か
3. **保守性**: テストコードが理解しやすいか
4. **信頼性**: フレーキーテスト（不安定なテスト）がないか

## テストの命名規則

```
テスト対象_条件_期待結果

例:
- Todo追加_正常な内容_保存される
- Todo追加_空文字_エラーが返る
- Todo完了_存在しないID_404エラー
```

## 関連ドキュメント

- [CLAUDE.md](../CLAUDE.md) - プロジェクト全体のルール
- [Memory Service](./MEMORY_SERVICE.md) - Memory Service の詳細

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-05 | 初版作成（10人レビューに基づく） |
