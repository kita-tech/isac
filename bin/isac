#!/bin/bash
# ISAC CLI - Intelligent System with Augmented Context
# メインエントリーポイント

set -e

VERSION="1.0.0"
ISAC_GLOBAL_DIR="${ISAC_GLOBAL_DIR:-$HOME/.isac}"
ISAC_SOURCE_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")/.." && pwd)"
ISAC_CACHE_FILE="${ISAC_GLOBAL_DIR}/.version_cache"
ISAC_CACHE_TTL=86400  # 24時間（秒）

# カラー出力
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ヘルプ表示
show_help() {
    echo -e "${CYAN}ISAC${NC} - Intelligent System with Augmented Context"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo "  isac <command> [options]"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  install       グローバルインストール (~/.isac/)"
    echo "  update        グローバル設定を最新に更新"
    echo "  init          現在のディレクトリでプロジェクト初期化"
    echo "  status        現在のプロジェクト状態とバージョン情報を表示"
    echo "  projects      登録済みプロジェクト一覧"
    echo "  switch <id>   プロジェクトを切り替え"
    echo "  help          このヘルプを表示"
    echo "  version       バージョン表示"
    echo ""
    echo -e "${YELLOW}Init Options:${NC}"
    echo "  -y, --yes     確認プロンプトをスキップ（すべてYesで回答）"
    echo "  -f, --force   既存ファイルを強制上書き"
    echo ""
    echo -e "${YELLOW}Status Options:${NC}"
    echo "  --no-cache    キャッシュを使わずリモートを確認"
    echo ""
    echo -e "${YELLOW}Switch Options:${NC}"
    echo "  -y, --yes     確認プロンプトをスキップ（新規プロジェクト自動作成）"
    echo ""
    echo -e "${YELLOW}Environment Variables:${NC}"
    echo "  ISAC_NO_CACHE=1   キャッシュを常に無効化（開発時に便利）"
    echo ""
    echo -e "${YELLOW}Persona Commands:${NC}"
    echo "  persona list      利用可能なペルソナ一覧"
    echo "  persona set <n>   ペルソナを設定（.isac.yaml を更新）"
    echo "  persona show      現在のペルソナを表示"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  isac install              # 初回セットアップ"
    echo "  isac init                 # プロジェクト初期化（対話式）"
    echo "  isac init my-project      # プロジェクト名を指定して初期化"
    echo "  isac init --yes           # 確認なしで初期化（CI/CD向け）"
    echo "  isac init --force         # 既存設定を上書きして再初期化"
    echo "  isac status               # 状態確認（キャッシュ使用）"
    echo "  isac status --no-cache    # 最新情報を取得"
    echo "  isac switch my-project    # プロジェクト切り替え"
    echo "  isac switch new-proj -y   # 新規プロジェクト自動作成"
    echo "  isac persona list         # ペルソナ一覧"
    echo "  isac persona set king-bonbi  # ペルソナ設定"
    echo ""
}

# バージョン表示
show_version() {
    echo "ISAC version ${VERSION}"
}

# プロジェクトIDのバリデーション
validate_project_id() {
    local id="$1"

    # 空チェック
    if [ -z "${id}" ]; then
        echo -e "${RED}Error: Project ID cannot be empty${NC}"
        return 1
    fi

    # 長さチェック（1-64文字）
    if [ ${#id} -gt 64 ]; then
        echo -e "${RED}Error: Project ID must be 64 characters or less${NC}"
        return 1
    fi

    # 禁止文字チェック（空白、スラッシュ、バックスラッシュ、制御文字）
    if echo "${id}" | grep -qE '[[:space:]/\\]'; then
        echo -e "${RED}Error: Project ID cannot contain spaces, slashes, or backslashes${NC}"
        return 1
    fi

    # 先頭・末尾のドットやハイフンをチェック
    if echo "${id}" | grep -qE '^[.-]|[.-]$'; then
        echo -e "${RED}Error: Project ID cannot start or end with a dot or hyphen${NC}"
        return 1
    fi

    return 0
}

# ペルソナ名のバリデーション
validate_persona_name() {
    local name="$1"

    # 空チェック
    if [ -z "${name}" ]; then
        echo -e "${RED}Error: Persona name cannot be empty${NC}"
        return 1
    fi

    # パストラバーサル防止（/, .., バックスラッシュ）
    if echo "${name}" | grep -qE '[/\\]|\.\.'; then
        echo -e "${RED}Error: Persona name cannot contain '/', '\\', or '..'${NC}"
        return 1
    fi

    # 英数字、ハイフン、アンダースコアのみ許可
    if ! echo "${name}" | grep -qE '^[a-zA-Z0-9_-]+$'; then
        echo -e "${RED}Error: Persona name can only contain alphanumeric characters, hyphens, and underscores${NC}"
        return 1
    fi

    return 0
}

# 現在のペルソナ名を取得
# 優先順位: .isac.yaml > ~/.isac/config.yaml > default
get_current_persona() {
    local persona=""

    # 1. .isac.yaml から取得
    if [ -f ".isac.yaml" ]; then
        persona=$(grep -E "^persona:" .isac.yaml | sed 's/persona: *//' | tr -d "\"'" || true)
    fi

    # 2. ~/.isac/config.yaml の default_persona から取得
    if [ -z "${persona}" ] && [ -f "${ISAC_GLOBAL_DIR}/config.yaml" ]; then
        persona=$(grep -E "^default_persona:" "${ISAC_GLOBAL_DIR}/config.yaml" | sed 's/default_persona: *//' | tr -d "\"'" || true)
    fi

    # 3. デフォルト
    if [ -z "${persona}" ]; then
        persona="default"
    fi

    echo "${persona}"
}

# ペルソナファイルのパスを取得（存在チェック付き）
get_persona_file() {
    local name="$1"
    local persona_file="${ISAC_GLOBAL_DIR}/personas/${name}.md"

    if [ ! -f "${persona_file}" ]; then
        echo ""
        return 1
    fi

    echo "${persona_file}"
}

# CLAUDE.md のマーカー間にペルソナを注入
inject_persona() {
    local claudemd_file="$1"
    local persona_name="$2"

    # CLAUDE.md が存在しない場合はスキップ
    if [ ! -f "${claudemd_file}" ]; then
        return 0
    fi

    # マーカーが存在しない場合はスキップ
    if ! grep -q '<!-- ISAC:PERSONA:BEGIN -->' "${claudemd_file}"; then
        return 0
    fi

    # ペルソナファイルを取得
    local persona_file
    persona_file=$(get_persona_file "${persona_name}")
    if [ -z "${persona_file}" ]; then
        echo -e "${YELLOW}Warning: Persona '${persona_name}' not found in ${ISAC_GLOBAL_DIR}/personas/${NC}"
        return 0
    fi

    # ペルソナの内容を読み込み
    local persona_content
    persona_content=$(cat "${persona_file}")

    # 一時ファイルを使ってマーカー間を置換
    local tmp_file
    tmp_file=$(mktemp)

    local in_persona=false
    while IFS= read -r line || [ -n "${line}" ]; do
        if echo "${line}" | grep -q '<!-- ISAC:PERSONA:BEGIN -->'; then
            echo "${line}" >> "${tmp_file}"
            echo "${persona_content}" >> "${tmp_file}"
            in_persona=true
        elif echo "${line}" | grep -q '<!-- ISAC:PERSONA:END -->'; then
            echo "${line}" >> "${tmp_file}"
            in_persona=false
        elif [ "${in_persona}" = false ]; then
            echo "${line}" >> "${tmp_file}"
        fi
    done < "${claudemd_file}"

    # 元のファイルを置換
    mv "${tmp_file}" "${claudemd_file}"
}

# バージョンキャッシュが有効か確認
is_cache_valid() {
    # ISAC_NO_CACHE 環境変数が設定されていたらキャッシュ無効
    if [ "${ISAC_NO_CACHE:-}" = "1" ]; then
        return 1
    fi

    # キャッシュファイルが存在しない
    if [ ! -f "${ISAC_CACHE_FILE}" ]; then
        return 1
    fi

    # キャッシュの有効期限をチェック
    local cache_time current_time
    cache_time=$(stat -f %m "${ISAC_CACHE_FILE}" 2>/dev/null || stat -c %Y "${ISAC_CACHE_FILE}" 2>/dev/null || echo 0)
    current_time=$(date +%s)

    if [ $((current_time - cache_time)) -gt ${ISAC_CACHE_TTL} ]; then
        return 1
    fi

    return 0
}

# リモートの最新情報を取得してキャッシュ
fetch_remote_version() {
    local remote_head

    # タイムアウト2秒でリモートHEADを取得
    remote_head=$(git ls-remote --heads origin main 2>/dev/null | cut -f1 | head -c 7 || echo "")

    if [ -n "${remote_head}" ]; then
        mkdir -p "$(dirname "${ISAC_CACHE_FILE}")"
        echo "${remote_head}" > "${ISAC_CACHE_FILE}"
        echo "${remote_head}"
    else
        echo ""
    fi
}

# キャッシュまたはリモートからバージョン取得
get_remote_version() {
    local use_cache="${1:-true}"

    if [ "${use_cache}" = "true" ] && is_cache_valid; then
        cat "${ISAC_CACHE_FILE}"
    else
        fetch_remote_version
    fi
}

# グローバルインストール
cmd_install() {
    echo -e "${BLUE}=== ISAC Global Install ===${NC}"
    echo ""

    # ディレクトリ作成
    echo -e "${GREEN}[1/7] Creating ~/.isac/ directory...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}"
    chmod 700 "${ISAC_GLOBAL_DIR}"

    # Hooks コピー
    echo -e "${GREEN}[2/7] Installing hooks...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/hooks"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/hooks" ]; then
        cp -f "${ISAC_SOURCE_DIR}/.claude/hooks/"*.sh "${ISAC_GLOBAL_DIR}/hooks/" 2>/dev/null || true
        chmod +x "${ISAC_GLOBAL_DIR}/hooks/"*.sh 2>/dev/null || true
        echo -e "  Copied hooks to ${ISAC_GLOBAL_DIR}/hooks/"
    else
        echo -e "${YELLOW}  Warning: Source hooks not found${NC}"
    fi

    # Skills コピー（ディレクトリ構造）
    echo -e "${GREEN}[3/7] Installing skills...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/skills"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/skills" ]; then
        # 既存のスキルを削除して再コピー
        rm -rf "${ISAC_GLOBAL_DIR}/skills/"*
        cp -rf "${ISAC_SOURCE_DIR}/.claude/skills/"* "${ISAC_GLOBAL_DIR}/skills/" 2>/dev/null || true
        echo -e "  Copied skills to ${ISAC_GLOBAL_DIR}/skills/"
    else
        echo -e "${YELLOW}  Warning: Source skills not found${NC}"
    fi

    # 旧バージョンの ~/.claude/skills/ コピーをクリーンアップ
    if ls "${HOME}/.claude/skills/"isac-* >/dev/null 2>&1; then
        rm -rf "${HOME}/.claude/skills/"isac-*
        echo -e "  Cleaned up old skills from ~/.claude/skills/"
    fi

    # Agents コピー（SubAgent定義）
    echo -e "${GREEN}[4/7] Installing agents...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/agents"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/agents" ]; then
        cp -f "${ISAC_SOURCE_DIR}/.claude/agents/"*.md "${ISAC_GLOBAL_DIR}/agents/" 2>/dev/null || true
        echo -e "  Copied agents to ${ISAC_GLOBAL_DIR}/agents/"
    else
        echo -e "${YELLOW}  Warning: Source agents not found${NC}"
    fi

    # Personas コピー
    echo -e "${GREEN}[5/7] Installing personas...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/personas"
    if [ -d "${ISAC_SOURCE_DIR}/templates/personas" ]; then
        cp -f "${ISAC_SOURCE_DIR}/templates/personas/"*.md "${ISAC_GLOBAL_DIR}/personas/" 2>/dev/null || true
        local persona_count
        persona_count=$(ls -1 "${ISAC_GLOBAL_DIR}/personas/"*.md 2>/dev/null | wc -l | tr -d ' ')
        echo -e "  Copied ${persona_count} personas to ${ISAC_GLOBAL_DIR}/personas/"
    else
        echo -e "${YELLOW}  Warning: Source personas not found${NC}"
    fi

    # CLAUDE.md コピー（~/.isac/CLAUDE.md → ~/.claude/CLAUDE.md）
    echo -e "${GREEN}[6/7] Setting up CLAUDE.md...${NC}"
    if [ -f "${ISAC_SOURCE_DIR}/templates/CLAUDE.md.template" ]; then
        # テンプレートから~/.isac/CLAUDE.md を作成（言語設定セクションのみ抽出）
        if [ ! -f "${ISAC_GLOBAL_DIR}/CLAUDE.md" ]; then
            cat > "${ISAC_GLOBAL_DIR}/CLAUDE.md" << 'CLAUDEMD_EOF'
# ISAC グローバル設定

## 言語設定

**すべての応答は日本語で行うこと。**
CLAUDEMD_EOF
            echo -e "  Created ${ISAC_GLOBAL_DIR}/CLAUDE.md"
        else
            echo -e "${YELLOW}  CLAUDE.md already exists, skipping${NC}"
        fi

        # ~/.claude/CLAUDE.md にコピー
        mkdir -p "${HOME}/.claude"
        cp -f "${ISAC_GLOBAL_DIR}/CLAUDE.md" "${HOME}/.claude/CLAUDE.md"
        echo -e "  Copied to ~/.claude/CLAUDE.md"
    fi

    # 設定ファイル作成
    echo -e "${GREEN}[7/7] Creating config.yaml...${NC}"
    if [ ! -f "${ISAC_GLOBAL_DIR}/config.yaml" ]; then
        cat > "${ISAC_GLOBAL_DIR}/config.yaml" << 'EOF'
# ISAC Global Configuration
version: 1

# Memory Service URL
memory_service_url: http://localhost:8100

# Default project (optional)
# default_project: my-project

# Team ID (for team knowledge sharing)
# team_id: my-team

# Default persona (optional, applied when .isac.yaml has no persona field)
# Available personas: ls ~/.isac/personas/
# default_persona: king-bonbi
EOF
        echo -e "  Created ${ISAC_GLOBAL_DIR}/config.yaml"
    else
        echo -e "${YELLOW}  config.yaml already exists, skipping${NC}"
    fi

    echo ""
    echo -e "${GREEN}=== Install Complete ===${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "  1. Add to PATH (optional):"
    echo "     echo 'export PATH=\"${ISAC_SOURCE_DIR}/bin:\$PATH\"' >> ~/.zshrc"
    echo ""
    echo "  2. Start Memory Service:"
    echo "     cd ${ISAC_SOURCE_DIR}/memory-service && docker compose up -d"
    echo ""
    echo "  3. Initialize a project:"
    echo "     cd /path/to/your/project && isac init"
    echo ""
}

# グローバル設定の更新
cmd_update() {
    echo -e "${BLUE}=== ISAC Update ===${NC}"
    echo ""

    if [ ! -d "${ISAC_GLOBAL_DIR}" ]; then
        echo -e "${RED}Error: ISAC not installed. Run 'isac install' first.${NC}"
        exit 1
    fi

    # Hooks 更新
    echo -e "${GREEN}[1/5] Updating hooks...${NC}"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/hooks" ]; then
        cp -f "${ISAC_SOURCE_DIR}/.claude/hooks/"*.sh "${ISAC_GLOBAL_DIR}/hooks/" 2>/dev/null || true
        chmod +x "${ISAC_GLOBAL_DIR}/hooks/"*.sh 2>/dev/null || true
        echo -e "  Updated hooks"
    fi

    # Skills 更新（ディレクトリ構造）
    echo -e "${GREEN}[2/5] Updating skills...${NC}"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/skills" ]; then
        rm -rf "${ISAC_GLOBAL_DIR}/skills/"*
        cp -rf "${ISAC_SOURCE_DIR}/.claude/skills/"* "${ISAC_GLOBAL_DIR}/skills/" 2>/dev/null || true
        echo -e "  Updated skills in ~/.isac/skills/"
    fi

    # 旧バージョンの ~/.claude/skills/ コピーをクリーンアップ
    if ls "${HOME}/.claude/skills/"isac-* >/dev/null 2>&1; then
        rm -rf "${HOME}/.claude/skills/"isac-*
        echo -e "  Cleaned up old skills from ~/.claude/skills/"
    fi

    # Agents 更新
    echo -e "${GREEN}[3/5] Updating agents...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/agents"
    if [ -d "${ISAC_SOURCE_DIR}/.claude/agents" ]; then
        cp -f "${ISAC_SOURCE_DIR}/.claude/agents/"*.md "${ISAC_GLOBAL_DIR}/agents/" 2>/dev/null || true
        echo -e "  Updated agents"
    fi

    # Personas 更新
    echo -e "${GREEN}[4/5] Updating personas...${NC}"
    mkdir -p "${ISAC_GLOBAL_DIR}/personas"
    if [ -d "${ISAC_SOURCE_DIR}/templates/personas" ]; then
        cp -f "${ISAC_SOURCE_DIR}/templates/personas/"*.md "${ISAC_GLOBAL_DIR}/personas/" 2>/dev/null || true
        local persona_count
        persona_count=$(ls -1 "${ISAC_GLOBAL_DIR}/personas/"*.md 2>/dev/null | wc -l | tr -d ' ')
        echo -e "  Updated ${persona_count} personas in ~/.isac/personas/"
    fi

    # CLAUDE.md 更新（~/.isac/CLAUDE.md → ~/.claude/CLAUDE.md）
    echo -e "${GREEN}[5/5] Updating CLAUDE.md...${NC}"
    if [ -f "${ISAC_GLOBAL_DIR}/CLAUDE.md" ]; then
        mkdir -p "${HOME}/.claude"
        cp -f "${ISAC_GLOBAL_DIR}/CLAUDE.md" "${HOME}/.claude/CLAUDE.md"
        echo -e "  Updated ~/.claude/CLAUDE.md"
    else
        echo -e "  ${YELLOW}~/.isac/CLAUDE.md not found, skipping${NC}"
    fi

    echo ""
    echo -e "${GREEN}Update complete!${NC}"
}

# プロジェクト初期化
cmd_init() {
    local project_id=""
    local flag_yes=false
    local flag_force=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yes|-y)
                flag_yes=true
                shift
                ;;
            --force|-f)
                flag_force=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
            *)
                project_id="$1"
                shift
                ;;
        esac
    done

    echo -e "${BLUE}=== ISAC Project Init ===${NC}"
    echo ""

    # プロジェクトIDの決定
    # 優先順位: 引数 > 既存 .isac.yaml > ディレクトリ名（basename）
    if [ -z "${project_id}" ]; then
        # 既存の.isac.yamlからproject_idを引き継ぐ
        if [ -f ".isac.yaml" ]; then
            project_id=$(grep -E "^project_id:" .isac.yaml | sed 's/project_id: *//' | tr -d "\"'" || true)
        fi
        if [ -z "${project_id}" ]; then
            project_id="$(basename "$(pwd)")"
        fi
        if [ "${flag_yes}" = false ]; then
            echo -n "Project ID [${project_id}]: "
            read -r input_id
            if [ -n "${input_id}" ]; then
                project_id="${input_id}"
            fi
        fi
    fi

    # プロジェクトIDのバリデーション
    if ! validate_project_id "${project_id}"; then
        exit 1
    fi

    # 既存の persona フィールドを保持
    local existing_persona=""
    if [ -f ".isac.yaml" ]; then
        existing_persona=$(grep -E "^persona:" .isac.yaml | sed 's/persona: *//' | tr -d "\"'" || true)
    fi

    # .isac.yaml 作成
    if [ -f ".isac.yaml" ] && [ "${flag_force}" = false ]; then
        echo -e "${YELLOW}Warning: .isac.yaml already exists${NC}"
        if [ "${flag_yes}" = false ]; then
            echo -n "Overwrite? (y/N): "
            read -r overwrite
            if [ "${overwrite}" != "y" ] && [ "${overwrite}" != "Y" ]; then
                echo "Cancelled."
                exit 0
            fi
        fi
    fi

    cat > ".isac.yaml" << EOF
# ISAC Project Configuration
project_id: ${project_id}

# Team ID (optional, for team knowledge sharing)
# team_id: my-team
EOF

    # 既存の persona フィールドを復元
    if [ -n "${existing_persona}" ]; then
        echo "persona: ${existing_persona}" >> ".isac.yaml"
    fi

    echo -e "${GREEN}✓ Created .isac.yaml${NC}"

    # ========================================
    # .isac.secrets.yaml.example の生成
    # ========================================
    if [ ! -f ".isac.secrets.yaml.example" ] || [ "${flag_force}" = true ]; then
        cat > ".isac.secrets.yaml.example" << 'SECRETS_EOF'
# ISAC Secrets Configuration
# コピーして .isac.secrets.yaml を作成:
#   cp .isac.secrets.yaml.example .isac.secrets.yaml
#   chmod 600 .isac.secrets.yaml
#
# KEY: VALUE のフラット形式のみサポート
# 許可キー: NOTION_API_TOKEN, CONTEXT7_API_KEY
# 優先順位: .isac.secrets.yaml > 環境変数

# Notion API Token (https://www.notion.so/my-integrations)
# NOTION_API_TOKEN: YOUR_NOTION_API_TOKEN_HERE

# Context7 API Key (https://context7.com/dashboard)
# CONTEXT7_API_KEY: YOUR_CONTEXT7_API_KEY_HERE
SECRETS_EOF
        echo -e "${GREEN}✓ Created .isac.secrets.yaml.example${NC}"
    fi

    # ========================================
    # .gitignore に .isac.secrets.yaml を追記
    # ========================================
    if [ -f ".gitignore" ]; then
        if ! grep -q '\.isac\.secrets\.yaml$' ".gitignore"; then
            echo "" >> ".gitignore"
            echo "# ISAC secrets (DO NOT commit)" >> ".gitignore"
            echo ".isac.secrets.yaml" >> ".gitignore"
            echo -e "${GREEN}✓ Added .isac.secrets.yaml to .gitignore${NC}"
        fi
    fi

    # ========================================
    # .claude/ ディレクトリの自動作成
    # ========================================
    local create_claude_dir=false

    if [ ! -d ".claude" ]; then
        echo ""
        echo -e "${YELLOW}Claude Code integration:${NC}"
        echo "  .claude/ directory not found."

        if [ "${flag_yes}" = true ]; then
            create_claude_dir=true
        else
            echo -n "  Create with global hooks/skills inheritance? [Y/n]: "
            read -r answer
            if [ -z "${answer}" ] || [ "${answer}" = "y" ] || [ "${answer}" = "Y" ]; then
                create_claude_dir=true
            fi
        fi
    elif [ "${flag_force}" = true ]; then
        create_claude_dir=true
        echo ""
        echo -e "${YELLOW}Force mode: Recreating .claude/ configuration${NC}"
    fi

    if [ "${create_claude_dir}" = true ]; then
        setup_claude_directory "${flag_force}"
        setup_mcp_servers "${flag_force}"
    fi

    # ペルソナの注入（CLAUDE.md のマーカー間を更新）
    local current_persona
    current_persona=$(get_current_persona)
    if [ -f "CLAUDE.md" ] && [ -d "${ISAC_GLOBAL_DIR}/personas" ]; then
        inject_persona "CLAUDE.md" "${current_persona}"
        echo -e "${GREEN}✓ Persona: ${CYAN}${current_persona}${NC}"
    fi

    echo ""
    echo -e "Project ID: ${CYAN}${project_id}${NC}"
    echo ""

    # Memory Service に接続確認
    local memory_url
    memory_url=$(get_memory_url)

    if curl -s --connect-timeout 2 "${memory_url}/health" > /dev/null 2>&1; then
        echo -e "Memory Service: ${GREEN}Connected${NC} (${memory_url})"

        # プロジェクト情報取得
        local project_info
        project_info=$(curl -s "${memory_url}/projects" 2>/dev/null | grep -o "\"project_id\":\"${project_id}\"" || true)

        if [ -n "${project_info}" ]; then
            echo -e "Status: ${CYAN}Existing project found${NC}"
        else
            echo -e "Status: ${YELLOW}New project${NC}"
        fi
    else
        echo -e "Memory Service: ${YELLOW}Not connected${NC}"
        echo "  Start with: cd ${ISAC_SOURCE_DIR}/memory-service && docker compose up -d"
    fi

    # secrets ファイルの案内
    if [ ! -f ".isac.secrets.yaml" ]; then
        echo ""
        echo -e "${YELLOW}MCP secrets:${NC}"
        echo "  cp .isac.secrets.yaml.example .isac.secrets.yaml"
        echo "  chmod 600 .isac.secrets.yaml"
        echo "  Then edit with your API keys."
    fi

    echo ""
    echo -e "${GREEN}✅ Project initialized!${NC}"
    echo "Run 'claude' to start developing with ISAC."
}

# 許可するシークレットキーのホワイトリスト
ALLOWED_SECRET_KEYS="NOTION_API_TOKEN CONTEXT7_API_KEY"

# .isac.secrets.yaml からシークレットを読み込み、環境変数として export する
load_secrets() {
    local secrets_file=".isac.secrets.yaml"
    if [ ! -f "${secrets_file}" ]; then
        return 0
    fi

    # パーミッションチェック（警告のみ）
    local file_perm
    file_perm=$(stat -f "%Lp" "${secrets_file}" 2>/dev/null || stat -c "%a" "${secrets_file}" 2>/dev/null || echo "unknown")
    if [ "${file_perm}" != "600" ] && [ "${file_perm}" != "unknown" ]; then
        echo -e "  ${YELLOW}⚠${NC} ${secrets_file} has permissions ${file_perm}, expected 600" >&2
        echo -e "    Run: chmod 600 ${secrets_file}" >&2
    fi

    local line key value
    while IFS= read -r line || [ -n "${line}" ]; do
        # コメント行・空行スキップ
        case "${line}" in
            '#'*|'') continue ;;
        esac
        # 空白のみの行もスキップ
        [[ "${line}" =~ ^[[:space:]]*$ ]] && continue

        # KEY: VALUE を分離（最初のコロンで分割）
        key="${line%%:*}"
        [ "${key}" = "${line}" ] && continue  # コロンなし → スキップ
        value="${line#*:}"

        # 前後空白除去
        key=$(echo "${key}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        value=$(echo "${value}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        # クォート除去
        value=$(echo "${value}" | sed "s/^['\"]//;s/['\"]$//")

        # ホワイトリストチェック
        local allowed=false
        for allowed_key in ${ALLOWED_SECRET_KEYS}; do
            [ "${key}" = "${allowed_key}" ] && allowed=true && break
        done
        if [ "${allowed}" = false ]; then
            echo -e "  ${YELLOW}⚠${NC} Unknown key '${key}' in ${secrets_file} (ignored)" >&2
            continue
        fi

        # 空でなければ export
        [ -n "${value}" ] && export "${key}=${value}"
    done < "${secrets_file}"
}

# MCP サーバーを個別に登録するヘルパー
# 引数: name env_var force [claude mcp add のオプション...]
register_mcp_server() {
    local name="$1"
    local env_var="$2"
    local force="$3"
    shift 3
    local env_val="${!env_var:-}"

    if [ "${force}" = true ]; then
        if [ -n "${env_val}" ]; then
            claude mcp remove "${name}" >/dev/null 2>&1 || true
            if claude mcp add --scope user "$@" >/dev/null 2>&1; then
                echo -e "  ${GREEN}✓${NC} ${name}: re-registered"
            else
                echo -e "  ${YELLOW}⚠${NC} ${name}: re-registration failed"
            fi
        else
            echo -e "  ${YELLOW}⚠${NC} ${env_var} not set, skipping ${name}"
        fi
    elif ! claude mcp get "${name}" >/dev/null 2>&1; then
        if [ -n "${env_val}" ]; then
            if claude mcp add --scope user "$@" >/dev/null 2>&1; then
                echo -e "  ${GREEN}✓${NC} ${name}: registered"
            else
                echo -e "  ${YELLOW}⚠${NC} ${name}: registration failed"
            fi
        else
            echo -e "  ${YELLOW}⚠${NC} ${env_var} not set, skipping ${name}"
        fi
    else
        echo -e "  ${GREEN}✓${NC} ${name}: already registered"
    fi
}

# MCP サーバーを claude mcp add で登録
setup_mcp_servers() {
    local force="${1:-false}"

    echo ""
    echo -e "${GREEN}Setting up MCP servers...${NC}"

    # .isac.secrets.yaml からシークレットをロード（環境変数を上書き）
    load_secrets

    if ! command -v claude &>/dev/null; then
        echo -e "  ${YELLOW}⚠${NC} claude CLI not found, skipping MCP registration"
        echo ""
        echo "  To register MCP servers manually, install Claude Code CLI and run:"
        echo "    claude mcp add --scope user -e OPENAPI_MCP_HEADERS='{\"Authorization\": \"Bearer \$NOTION_API_TOKEN\", \"Notion-Version\": \"2022-06-28\"}' notion -- npx -y @notionhq/notion-mcp-server"
        echo "    claude mcp add --scope user -e DEFAULT_MINIMUM_TOKENS=10000 -e CONTEXT7_API_KEY=\$CONTEXT7_API_KEY context7 -- npx -y @upstash/context7-mcp"
        return 0
    fi

    # notion
    register_mcp_server "notion" "NOTION_API_TOKEN" "${force}" \
        -e 'OPENAPI_MCP_HEADERS={"Authorization": "Bearer '"${NOTION_API_TOKEN}"'", "Notion-Version": "2022-06-28"}' \
        notion -- npx -y @notionhq/notion-mcp-server

    # context7
    register_mcp_server "context7" "CONTEXT7_API_KEY" "${force}" \
        -e "DEFAULT_MINIMUM_TOKENS=10000" \
        -e "CONTEXT7_API_KEY=${CONTEXT7_API_KEY}" \
        context7 -- npx -y @upstash/context7-mcp
}

# settings.yaml を新規作成
create_settings_yaml() {
    local settings_file=".claude/settings.yaml"

    cat > "${settings_file}" << 'SETTINGS_EOF'
# ============================================================================
# ISAC Project Settings for Claude Code CLI
# ============================================================================
#
# 【このファイルは何？】
# Claude Code CLI（claudeコマンド）の設定ファイルです。
# ISACの機能（記憶管理、決定事項の保存など）を有効にするための設定が
# 記述されています。
#
# 【MCP サーバーについて】
# MCP サーバー（notion, context7）は `claude mcp add --scope user` で
# 登録されます（~/.claude.json に保存）。
# `isac init` 実行時に自動登録されますが、手動で登録する場合：
#
#   claude mcp add --scope user \
#     -e 'OPENAPI_MCP_HEADERS={"Authorization": "Bearer $NOTION_API_TOKEN", "Notion-Version": "2022-06-28"}' \
#     notion -- npx -y @notionhq/notion-mcp-server
#
#   claude mcp add --scope user \
#     -e DEFAULT_MINIMUM_TOKENS=10000 \
#     -e CONTEXT7_API_KEY=$CONTEXT7_API_KEY \
#     context7 -- npx -y @upstash/context7-mcp
#
# 【ISACとの連携の仕組み】
# このプロジェクトは、グローバル設定（~/.isac/）を継承しています。
#
#   ~/.isac/                    ← グローバル設定（全プロジェクト共通）
#   ├── hooks/                  ← 自動実行されるスクリプト
#   │   ├── on-prompt.sh       ← プロンプト入力時に記憶を検索
#   │   ├── post-edit.sh       ← ファイル編集後に作業履歴を保存
#   │   └── ...
#   └── skills/                 ← スラッシュコマンド定義（ディレクトリ構造）
#       ├── isac-memory/
#       │   └── SKILL.md       ← /isac-memory コマンド
#       ├── isac-decide/
#       │   └── SKILL.md       ← /isac-decide コマンド
#       └── ...
#
#   .claude/                    ← このプロジェクト固有の設定
#   ├── settings.yaml          ← このファイル
#   ├── hooks/                  ← グローバルへのシンボリックリンク
#   └── skills/                 ← グローバルへのシンボリックリンク
#
# 【シンボリックリンクとは？】
# ファイルやフォルダへの「ショートカット」のようなものです。
# .claude/hooks/ の中身は実際には ~/.isac/hooks/ を参照しています。
# これにより：
#   - グローバル設定を更新すると、全プロジェクトに自動反映
#   - プロジェクトごとに個別のファイルを追加することも可能
#
# 【カスタマイズ方法】
#
# 1. プロジェクト固有のHookを追加したい場合：
#    .claude/hooks/ に新しいスクリプトを作成してください。
#    （シンボリックリンクではなく、実ファイルとして作成）
#
#    例: .claude/hooks/my-custom-hook.sh
#
# 2. 特定のHookを無効化したい場合：
#    このファイルで hooks セクションを定義し、必要なものだけ指定します。
#
# 3. グローバル設定を使わない場合：
#    hooks/ と skills/ のシンボリックリンクを削除し、
#    このファイルで直接パスを指定するか、独自のスクリプトを配置します。
#

# ============================================================================
# 設定セクション
# ============================================================================

# Hooks と Skills はシンボリックリンクで継承しているため、追加設定は不要です。
#
# プロジェクト固有の設定を追加する場合は、以下のようにコメントを外して
# 必要な設定を追加してください：
#
# hooks:
#   # プロンプト入力時に実行されるHook
#   prompt:
#     - .claude/hooks/my-prompt-hook.sh
#
#   # ファイル編集後に実行されるHook
#   post_tool_use:
#     Edit:
#       - .claude/hooks/my-edit-hook.sh
#     Write:
#       - .claude/hooks/my-write-hook.sh

# ============================================================================
# よくある質問（FAQ）
# ============================================================================
#
# Q: グローバル設定はどこにある？
# A: ~/.isac/ ディレクトリです。`isac status` で確認できます。
#
# Q: Hookが動いているか確認したい
# A: Claude Code CLI で何か質問すると、画面上部に「ISAC Context」という
#    セクションが表示されれば、on-prompt.sh が動作しています。
#
# Q: 記憶が保存されない
# A: Memory Service が起動しているか確認してください。
#    `curl http://localhost:8100/health` で確認できます。
#
# Q: このファイルを削除したらどうなる？
# A: ISACの機能（記憶管理など）が動作しなくなります。
#    `isac init --force` で再作成できます。
#
# Q: チームメンバーと設定を共有したい
# A: このファイルと .isac.yaml はGitにコミットしてOKです。
#    ただし、hooks/ と skills/ のシンボリックリンクは各自の環境に
#    依存するため、.gitignore に追加することを推奨します。
#    各メンバーは `isac init --force` で自分の環境にリンクを再作成できます。
#
# Q: MCP サーバーはどこで管理される？
# A: `claude mcp add --scope user` で ~/.claude.json に登録されます。
#    `claude mcp list` で確認、`claude mcp remove <name>` で削除できます。
#
# ============================================================================
SETTINGS_EOF

    echo -e "  ${GREEN}✓${NC} Created .claude/settings.yaml"
}


# .claude/ ディレクトリのセットアップ
setup_claude_directory() {
    local force="${1:-false}"

    echo ""
    echo -e "${GREEN}Setting up .claude/ directory...${NC}"

    # ディレクトリ作成
    mkdir -p .claude/hooks .claude/skills .claude/agents

    # ========================================
    # settings.yaml の作成
    # ========================================
    if [ ! -f ".claude/settings.yaml" ] || [ "${force}" = true ]; then
        create_settings_yaml
    fi

    echo -e "  ${GREEN}✓${NC} .claude/settings.yaml ready"

    # ========================================
    # シンボリックリンクの作成
    # ========================================

    # グローバル設定が存在するか確認
    if [ ! -d "${ISAC_GLOBAL_DIR}/hooks" ]; then
        echo -e "  ${YELLOW}⚠${NC} Global hooks not found (~/.isac/hooks/)"
        echo "     Run 'isac install' first to set up global configuration."
    else
        # 既存のリンク/ファイルを削除して新しいリンクを作成
        rm -rf .claude/hooks/*

        # 各Hookファイルへのシンボリックリンクを作成
        for hook_file in "${ISAC_GLOBAL_DIR}/hooks/"*.sh; do
            if [ -f "${hook_file}" ]; then
                local filename
                filename=$(basename "${hook_file}")
                ln -sf "${hook_file}" ".claude/hooks/${filename}"
            fi
        done

        local hook_count
        hook_count=$(ls -1 .claude/hooks/*.sh 2>/dev/null | wc -l | tr -d ' ')
        echo -e "  ${GREEN}✓${NC} Linked ${hook_count} hooks from ~/.isac/hooks/"
    fi

    if [ ! -d "${ISAC_GLOBAL_DIR}/skills" ]; then
        echo -e "  ${YELLOW}⚠${NC} Global skills not found (~/.isac/skills/)"
        echo "     Run 'isac install' first to set up global configuration."
    else
        # Git管理されたスキルファイルがある場合はシンボリックリンク作成をスキップ
        if git ls-files --error-unmatch .claude/skills/ >/dev/null 2>&1; then
            local skill_count
            skill_count=$(ls -1d .claude/skills/*/ 2>/dev/null | wc -l | tr -d ' ')
            echo -e "  ${GREEN}✓${NC} Skills: ${skill_count} Git-managed skills (skipped symlink)"
        else
            # 既存のリンク/ファイルを削除して新しいリンクを作成
            rm -rf .claude/skills/*

            # 各Skillディレクトリへのシンボリックリンクを作成
            for skill_dir in "${ISAC_GLOBAL_DIR}/skills/"*/; do
                if [ -d "${skill_dir}" ]; then
                    local dirname
                    dirname=$(basename "${skill_dir}")
                    ln -sf "${skill_dir}" ".claude/skills/${dirname}"
                fi
            done

            local skill_count
            skill_count=$(ls -1d .claude/skills/*/ 2>/dev/null | wc -l | tr -d ' ')
            echo -e "  ${GREEN}✓${NC} Linked ${skill_count} skills from ~/.isac/skills/"
        fi
    fi

    # Agentsシンボリックリンク
    if [ ! -d "${ISAC_GLOBAL_DIR}/agents" ]; then
        echo -e "  ${YELLOW}⚠${NC} Global agents not found (~/.isac/agents/)"
        echo "     Run 'isac install' first to set up global configuration."
    else
        # 既存のリンク/ファイルを削除して新しいリンクを作成
        rm -rf .claude/agents/*

        # 各Agentファイルへのシンボリックリンクを作成
        for agent_file in "${ISAC_GLOBAL_DIR}/agents/"*.md; do
            if [ -f "${agent_file}" ]; then
                local filename
                filename=$(basename "${agent_file}")
                ln -sf "${agent_file}" ".claude/agents/${filename}"
            fi
        done

        local agent_count
        agent_count=$(ls -1 .claude/agents/*.md 2>/dev/null | wc -l | tr -d ' ')
        echo -e "  ${GREEN}✓${NC} Linked ${agent_count} agents from ~/.isac/agents/"
    fi

    # ========================================
    # .gitignore への追記提案
    # ========================================
    echo ""
    echo -e "${YELLOW}Note:${NC} Consider adding to .gitignore:"
    echo "  .claude/hooks/"
    echo "  .claude/skills/"
    echo "  .claude/agents/"
    echo ""
    echo "  These are symlinks to your local ~/.isac/ directory."
    echo "  Team members should run 'isac init --force' to create their own links."
}

# 状態表示
cmd_status() {
    local use_cache="true"

    # 引数処理
    while [ $# -gt 0 ]; do
        case "$1" in
            --no-cache)
                use_cache="false"
                ;;
        esac
        shift
    done

    echo -e "${BLUE}=== ISAC Status ===${NC}"
    echo ""

    # バージョン情報（Git管理下の場合のみ）
    if [ -d "${ISAC_SOURCE_DIR}/.git" ]; then
        local local_head local_date remote_head commits_behind
        local_head=$(git -C "${ISAC_SOURCE_DIR}" rev-parse --short HEAD 2>/dev/null || echo "unknown")
        local_date=$(git -C "${ISAC_SOURCE_DIR}" log -1 --format=%cd --date=short 2>/dev/null || echo "unknown")

        echo -e "${YELLOW}Version:${NC}"
        echo "  Local: ${local_head} (${local_date})"

        # リモートとの比較
        remote_head=$(get_remote_version "${use_cache}")

        if [ -n "${remote_head}" ]; then
            if [ "${local_head}" = "${remote_head}" ]; then
                echo -e "  Status: ${GREEN}✓ Up to date${NC}"
            else
                # コミット差を計算
                git -C "${ISAC_SOURCE_DIR}" fetch origin main --quiet 2>/dev/null || true
                commits_behind=$(git -C "${ISAC_SOURCE_DIR}" rev-list --count HEAD..origin/main 2>/dev/null || echo "?")
                echo -e "  Status: ${YELLOW}⚠ Update available${NC} (${commits_behind} commits behind)"
                echo -e "  Remote: ${remote_head}"
            fi
        else
            echo -e "  Status: ${CYAN}? Could not check remote${NC}"
        fi

        # キャッシュ状態表示
        if [ "${use_cache}" = "false" ] || [ "${ISAC_NO_CACHE:-}" = "1" ]; then
            echo "  Cache: disabled"
        elif [ -f "${ISAC_CACHE_FILE}" ]; then
            local cache_age
            local cache_time current_time
            cache_time=$(stat -f %m "${ISAC_CACHE_FILE}" 2>/dev/null || stat -c %Y "${ISAC_CACHE_FILE}" 2>/dev/null || echo 0)
            current_time=$(date +%s)
            cache_age=$(( (current_time - cache_time) / 60 ))
            echo "  Cache: ${cache_age}m ago"
        fi

        # 最近の変更履歴
        echo ""
        echo -e "${YELLOW}Recent Changes:${NC}"
        git -C "${ISAC_SOURCE_DIR}" log --oneline -3 2>/dev/null | while read -r line; do
            echo "  ${line}"
        done

        echo ""
    fi

    # 現在のプロジェクト
    local project_id="(not set)"
    local project_source="none"

    if [ -f ".isac.yaml" ]; then
        project_id=$(grep -E "^project_id:" .isac.yaml | sed 's/project_id: *//' | tr -d '"' || echo "(not set)")
        project_source=".isac.yaml"
    elif [ -n "${CLAUDE_PROJECT:-}" ]; then
        project_id="${CLAUDE_PROJECT}"
        project_source="env:CLAUDE_PROJECT"
    fi

    echo -e "Project: ${CYAN}${project_id}${NC} (${project_source})"

    # 現在のペルソナ
    local current_persona
    current_persona=$(get_current_persona)
    echo -e "Persona: ${CYAN}${current_persona}${NC}"

    # Memory Service 接続
    local memory_url
    memory_url=$(get_memory_url)

    if curl -s --connect-timeout 2 "${memory_url}/health" > /dev/null 2>&1; then
        echo -e "Memory Service: ${GREEN}Connected${NC}"

        # プロジェクト統計
        if [ "${project_id}" != "(not set)" ]; then
            local stats
            stats=$(curl -s "${memory_url}/stats/${project_id}" 2>/dev/null || echo "{}")

            local memory_count decision_count
            memory_count=$(echo "${stats}" | grep -o '"count":[0-9]*' | head -1 | sed 's/"count"://' || echo "0")
            decision_count=$(echo "${stats}" | grep -o '"project/decision":{[^}]*"count":[0-9]*' | grep -o '"count":[0-9]*' | sed 's/"count"://' || echo "0")

            echo ""
            echo -e "${YELLOW}Statistics:${NC}"
            echo "  Memories: ${memory_count:-0}"
            echo "  Decisions: ${decision_count:-0}"
        fi
    else
        echo -e "Memory Service: ${RED}Not connected${NC}"
    fi

    # グローバル設定
    echo ""
    echo -e "${YELLOW}Global Config:${NC}"
    if [ -d "${ISAC_GLOBAL_DIR}" ]; then
        echo -e "  ~/.isac/: ${GREEN}Installed${NC}"
        local hook_count skill_count
        hook_count=$(ls -1 "${ISAC_GLOBAL_DIR}/hooks/"*.sh 2>/dev/null | wc -l | tr -d ' ')
        skill_count=$(ls -1d "${ISAC_GLOBAL_DIR}/skills/"*/ 2>/dev/null | wc -l | tr -d ' ')
        echo "  Hooks: ${hook_count}"
        echo "  Skills: ${skill_count}"
    else
        echo -e "  ~/.isac/: ${YELLOW}Not installed${NC} (run 'isac install')"
    fi
}

# プロジェクト一覧
cmd_projects() {
    local memory_url
    memory_url=$(get_memory_url)

    echo -e "${BLUE}=== Registered Projects ===${NC}"
    echo ""

    if ! curl -s --connect-timeout 2 "${memory_url}/health" > /dev/null 2>&1; then
        echo -e "${RED}Error: Memory Service not connected${NC}"
        exit 1
    fi

    local projects
    projects=$(curl -s "${memory_url}/projects" 2>/dev/null)

    if [ -z "${projects}" ] || [ "${projects}" = "[]" ]; then
        echo "No projects found."
        echo ""
        echo "Initialize a project with: isac init"
        exit 0
    fi

    # 現在のプロジェクト
    local current_project=""
    if [ -f ".isac.yaml" ]; then
        current_project=$(grep -E "^project_id:" .isac.yaml | sed 's/project_id: *//' | tr -d '"' || true)
    fi

    echo "${projects}" | python3 -c "
import json
import sys

data = json.load(sys.stdin)
current = '${current_project}'

for p in data:
    marker = ' *' if p['project_id'] == current else '  '
    print(f\"{marker} {p['project_id']}\")
    print(f\"     Memories: {p['memory_count']}, Decisions: {p['decision_count']}\")
    print(f\"     Last activity: {p['last_activity'][:10] if p['last_activity'] else 'N/A'}\")
    print()
" 2>/dev/null || echo "${projects}"
}

# プロジェクト切り替え
cmd_switch() {
    local project_id=""
    local flag_yes=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yes|-y)
                flag_yes=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
            *)
                project_id="$1"
                shift
                ;;
        esac
    done

    if [ -z "${project_id}" ]; then
        echo -e "${RED}Error: Project ID required${NC}"
        echo "Usage: isac switch <project-id> [--yes]"
        exit 1
    fi

    # プロジェクトIDのバリデーション
    if ! validate_project_id "${project_id}"; then
        exit 1
    fi

    echo -e "${BLUE}=== Switch Project ===${NC}"
    echo ""

    # Memory Service で確認
    local memory_url
    memory_url=$(get_memory_url)

    if curl -s --connect-timeout 2 "${memory_url}/health" > /dev/null 2>&1; then
        local suggestion encoded_id
        # URLエンコード（特殊文字対策）
        encoded_id=$(printf '%s' "${project_id}" | sed 's/ /%20/g; s/&/%26/g; s/?/%3F/g; s/#/%23/g')
        suggestion=$(curl -s "${memory_url}/projects/suggest?name=${encoded_id}" 2>/dev/null)

        local exact_match
        exact_match=$(echo "${suggestion}" | grep -o '"exact_match":true' || true)

        if [ -z "${exact_match}" ]; then
            echo -e "${YELLOW}Warning: Project '${project_id}' not found in Memory Service${NC}"

            local suggestions
            suggestions=$(echo "${suggestion}" | grep -o '"project_id":"[^"]*"' | sed 's/"project_id":"//;s/"//' || true)

            if [ -n "${suggestions}" ]; then
                echo "Did you mean:"
                echo "${suggestions}" | while read -r s; do
                    echo "  - ${s}"
                done
                echo ""
            fi

            if [ "${flag_yes}" = false ]; then
                echo -n "Create new project? (y/N): "
                read -r create
                if [ "${create}" != "y" ] && [ "${create}" != "Y" ]; then
                    echo "Cancelled."
                    exit 0
                fi
            fi
        fi
    fi

    # 既存の persona フィールドを保持
    local existing_persona=""
    if [ -f ".isac.yaml" ]; then
        existing_persona=$(grep -E "^persona:" .isac.yaml | sed 's/persona: *//' | tr -d "\"'" || true)
    fi

    # .isac.yaml 作成/更新
    if [ -n "${existing_persona}" ]; then
        cat > ".isac.yaml" << EOF
# ISAC Project Configuration
project_id: ${project_id}
persona: ${existing_persona}
EOF
    else
        cat > ".isac.yaml" << EOF
# ISAC Project Configuration
project_id: ${project_id}
EOF
    fi

    echo -e "${GREEN}Switched to: ${CYAN}${project_id}${NC}"

    # .isac.secrets.yaml があれば MCP サーバーを再登録
    if [ -f ".isac.secrets.yaml" ]; then
        setup_mcp_servers true
    fi

    # ペルソナの注入（CLAUDE.md のマーカー間を更新）
    local current_persona
    current_persona=$(get_current_persona)
    if [ -f "CLAUDE.md" ] && [ -d "${ISAC_GLOBAL_DIR}/personas" ]; then
        inject_persona "CLAUDE.md" "${current_persona}"
        echo -e "Persona: ${CYAN}${current_persona}${NC}"
    fi

    # 直近の決定事項を表示
    if curl -s --connect-timeout 2 "${memory_url}/health" > /dev/null 2>&1; then
        echo ""
        echo -e "${YELLOW}Recent decisions:${NC}"

        local decisions
        decisions=$(curl -s "${memory_url}/search?scope=project&scope_id=${project_id}&type=decision&limit=3" 2>/dev/null)

        echo "${decisions}" | python3 -c "
import json
import sys

try:
    data = json.load(sys.stdin)
    memories = data.get('memories', [])
    if not memories:
        print('  (no decisions yet)')
    else:
        for m in memories:
            summary = m.get('summary', m.get('content', '')[:50])
            print(f\"  - {summary}\")
except:
    print('  (could not fetch)')
" 2>/dev/null || echo "  (could not fetch)"
    fi
}

# Memory Service URL取得
get_memory_url() {
    local url="${MEMORY_SERVICE_URL:-}"

    if [ -z "${url}" ] && [ -f "${ISAC_GLOBAL_DIR}/config.yaml" ]; then
        url=$(grep -E "^memory_service_url:" "${ISAC_GLOBAL_DIR}/config.yaml" | sed 's/memory_service_url: *//' | tr -d '"' || true)
    fi

    echo "${url:-http://localhost:8100}"
}

# ペルソナコマンド
cmd_persona() {
    local subcmd="${1:-}"
    shift 2>/dev/null || true

    case "${subcmd}" in
        list)
            echo -e "${BLUE}=== Available Personas ===${NC}"
            echo ""

            if [ ! -d "${ISAC_GLOBAL_DIR}/personas" ]; then
                echo -e "${YELLOW}No personas installed.${NC}"
                echo "Run 'isac install' or 'isac update' first."
                exit 1
            fi

            local current_persona
            current_persona=$(get_current_persona)

            local found=false
            for persona_file in "${ISAC_GLOBAL_DIR}/personas/"*.md; do
                if [ -f "${persona_file}" ]; then
                    local name
                    name=$(basename "${persona_file}" .md)
                    if [ "${name}" = "${current_persona}" ]; then
                        echo -e "  ${GREEN}* ${name}${NC} (current)"
                    else
                        echo "    ${name}"
                    fi
                    found=true
                fi
            done

            if [ "${found}" = false ]; then
                echo "  (no personas found)"
            fi
            ;;

        set)
            local persona_name="${1:-}"

            if [ -z "${persona_name}" ]; then
                echo -e "${RED}Error: Persona name required${NC}"
                echo "Usage: isac persona set <name>"
                echo ""
                echo "Available personas:"
                for persona_file in "${ISAC_GLOBAL_DIR}/personas/"*.md; do
                    if [ -f "${persona_file}" ]; then
                        echo "  $(basename "${persona_file}" .md)"
                    fi
                done
                exit 1
            fi

            # バリデーション
            if ! validate_persona_name "${persona_name}"; then
                exit 1
            fi

            # ペルソナファイルの存在確認
            if [ ! -f "${ISAC_GLOBAL_DIR}/personas/${persona_name}.md" ]; then
                echo -e "${RED}Error: Persona '${persona_name}' not found${NC}"
                echo ""
                echo "Available personas:"
                for persona_file in "${ISAC_GLOBAL_DIR}/personas/"*.md; do
                    if [ -f "${persona_file}" ]; then
                        echo "  $(basename "${persona_file}" .md)"
                    fi
                done
                exit 1
            fi

            # .isac.yaml が存在しない場合はエラー
            if [ ! -f ".isac.yaml" ]; then
                echo -e "${RED}Error: .isac.yaml not found. Run 'isac init' first.${NC}"
                exit 1
            fi

            # .isac.yaml に persona フィールドを追加/更新
            if grep -q "^persona:" ".isac.yaml"; then
                # 既存の persona フィールドを更新
                local tmp_yaml
                tmp_yaml=$(mktemp)
                sed "s/^persona:.*/persona: ${persona_name}/" ".isac.yaml" > "${tmp_yaml}"
                mv "${tmp_yaml}" ".isac.yaml"
            else
                # persona フィールドを追加
                echo "persona: ${persona_name}" >> ".isac.yaml"
            fi

            # CLAUDE.md にペルソナを注入
            if [ -f "CLAUDE.md" ]; then
                inject_persona "CLAUDE.md" "${persona_name}"
            fi

            echo -e "${GREEN}Persona set to: ${CYAN}${persona_name}${NC}"

            # ペルソナの概要を表示
            local first_line
            first_line=$(grep -m1 "^#" "${ISAC_GLOBAL_DIR}/personas/${persona_name}.md" | sed 's/^# *//' || true)
            if [ -n "${first_line}" ]; then
                echo -e "  ${first_line}"
            fi
            ;;

        show)
            local current_persona
            current_persona=$(get_current_persona)

            echo -e "${BLUE}=== Current Persona ===${NC}"
            echo ""
            echo -e "Persona: ${CYAN}${current_persona}${NC}"

            # ソースを表示
            local source="default"
            if [ -f ".isac.yaml" ] && grep -qE "^persona:" .isac.yaml; then
                source=".isac.yaml"
            elif [ -f "${ISAC_GLOBAL_DIR}/config.yaml" ] && grep -qE "^default_persona:" "${ISAC_GLOBAL_DIR}/config.yaml"; then
                source="~/.isac/config.yaml (default_persona)"
            fi
            echo "Source: ${source}"

            # ペルソナファイルの内容を表示
            local persona_file="${ISAC_GLOBAL_DIR}/personas/${current_persona}.md"
            if [ -f "${persona_file}" ]; then
                echo ""
                echo -e "${YELLOW}--- Persona Content ---${NC}"
                cat "${persona_file}"
            else
                echo ""
                echo -e "${YELLOW}Warning: Persona file not found at ${persona_file}${NC}"
            fi
            ;;

        "")
            echo -e "${RED}Error: Subcommand required${NC}"
            echo "Usage: isac persona <list|set|show>"
            exit 1
            ;;

        *)
            echo -e "${RED}Unknown persona subcommand: ${subcmd}${NC}"
            echo "Usage: isac persona <list|set|show>"
            exit 1
            ;;
    esac
}

# メイン
case "${1:-}" in
    install)
        cmd_install
        ;;
    update)
        cmd_update
        ;;
    init)
        shift
        cmd_init "$@"
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    projects)
        cmd_projects
        ;;
    switch)
        shift
        cmd_switch "$@"
        ;;
    persona)
        shift
        cmd_persona "$@"
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: ${1}${NC}"
        echo "Run 'isac help' for usage."
        exit 1
        ;;
esac
